OCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E-LegalBoom — Document Intake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    h1, h2, h3 { margin-top: 28px; }
    label { display: block; margin-top: 12px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; }
    textarea { min-height: 80px; }
    .row { display: flex; gap: 16px; }
    .row > div { flex: 1; }
    .variant { border: 1px solid #ddd; padding: 16px; margin-top: 20px; display: none; }
    button { margin-top: 24px; padding: 12px 24px; font-size: 16px; }
    small { color: #666; }
  </style>
</head>
<body>

<h1>E-LegalBoom — Client Intake</h1>

<form id="intakeForm">

  <!-- =========================
       CUSTOMER
       ========================= -->
  <h2>Customer Information</h2>
  <div class="row">
    <div><label>First Name <input name="customer_first_name" required></label></div>
    <div><label>Last Name <input name="customer_last_name" required></label></div>
  </div>
  <label>Email <input name="customer_email" type="email" required></label>
  <label>Phone <input name="customer_phone"></label>
  <label>Business / Entity Name <input name="customer_business_name"></label>

  <!-- =========================
       ENTITY & JURISDICTION
       ========================= -->
  <h2>Entity & Jurisdiction</h2>
  <label>
    Entity Type
    <select name="entity_type">
      <option value="">Select…</option>
      <option>Individual</option>
      <option>LLC</option>
      <option>Corporation</option>
      <option>Partnership</option>
      <option>Trust</option>
    </select>
  </label>
  <label>Entity Name <input name="entity_name"></label>

  <label>
    Governing State
    <select name="governing_state" required>
      <option value="">Select…</option>
      <option>AL</option><option>AK</option><option>AZ</option><option>AR</option>
      <option>CA</option><option>CO</option><option>CT</option><option>DE</option>
      <option>FL</option><option>GA</option><option>HI</option><option>ID</option>
      <option>IL</option><option>IN</option><option>IA</option><option>KS</option>
      <option>KY</option><option>LA</option><option>ME</option><option>MD</option>
      <option>MA</option><option>MI</option><option>MN</option><option>MS</option>
      <option>MO</option><option>MT</option><option>NE</option><option>NV</option>
      <option>NH</option><option>NJ</option><option>NM</option><option>NY</option>
      <option>NC</option><option>ND</option><option>OH</option><option>OK</option>
      <option>OR</option><option>PA</option><option>RI</option><option>SC</option>
      <option>SD</option><option>TN</option><option>TX</option><option>UT</option>
      <option>VT</option><option>VA</option><option>WA</option><option>WV</option>
      <option>WI</option><option>WY</option>
    </select>
  </label>

  <!-- =========================
       PARTIES
       ========================= -->
  <h2>Parties</h2>
  <small>Add the primary parties involved.</small>

  <div class="row">
    <div><label>Party Name <input name="party1_name"></label></div>
    <div><label>Role <input name="party1_role"></label></div>
    <div><label>Email <input name="party1_email"></label></div>
  </div>

  <div class="row">
    <div><label>Party Name <input name="party2_name"></label></div>
    <div><label>Role <input name="party2_role"></label></div>
    <div><label>Email <input name="party2_email"></label></div>
  </div>

  <!-- =========================
       TIMELINE
       ========================= -->
  <h2>Timeline</h2>
  <label>Urgency <input name="urgency"></label>
  <label>Preferred Deadline <input name="preferred_deadline" type="date" id="preferred_deadline"></label>
  <label>Additional Notes <textarea name="delivery_notes"></textarea></label>

  <!-- =========================
       VARIANT (15%)
       ========================= -->
  <div id="variantSection" class="variant">
    <h3>Additional Details</h3>

    <label>Management Model
      <select name="management_model">
        <option value="">Select…</option>
        <option>Member-Managed</option>
        <option>Manager-Managed</option>
      </select>
    </label>

    <label>Dispute Resolution
      <select name="dispute_resolution">
        <option value="">Select…</option>
        <option>Litigation</option>
        <option>Arbitration</option>
        <option>Mediation</option>
      </select>
    </label>

    <label>Special Clauses
      <textarea name="special_clauses"></textarea>
    </label>
  </div>

  <button type="submit">Continue to Review & Pay</button>
</form>

<script>
  /* =========================
     CONFIG
     ========================= */
  const SUPABASE_URL = "https://vvjbjfltqsivvxxifnvi.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* =========================
     HELPERS
     ========================= */
  function generateOrderId() {
    const d = new Date().toISOString().slice(0,10).replace(/-/g,'');
    const r = Math.floor(1000 + Math.random() * 9000);
    return `ELB-${d}-${r}`;
  }

  // Default date to today
  document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    const dateField = document.getElementById("preferred_deadline");
    if (dateField && !dateField.value) dateField.value = today;
  });

  // Pull doc_type from tier/catalog
  const params = new URLSearchParams(window.location.search);
  const docType = params.get("doc_type");
  if (!docType) {
    alert("Missing document selection. Please return to the catalog.");
    window.location.href = "/catalog.html";
  }

  // Variant visibility (V1 example)
  const variantSection = document.getElementById("variantSection");
  if (docType === "llc_operating_agreement") {
    variantSection.style.display = "block";
  }

  /* =========================
     SUBMIT
     ========================= */
  document.getElementById("intakeForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const v = Object.fromEntries(fd.entries());

    const parties = [];
    if (v.party1_name) parties.push({ name: v.party1_name, role: v.party1_role, email: v.party1_email });
    if (v.party2_name) parties.push({ name: v.party2_name, role: v.party2_role, email: v.party2_email });

    const variant_data = {
      management_model: v.management_model || null,
      dispute_resolution: v.dispute_resolution || null,
      special_clauses: v.special_clauses || null,
      stripe: {
        product_key: docType,
        price_cents: null,
        tier: null,
        success_url: "/payment-success",
        cancel_url: "/review-and-pay"
      }
    };

    const payload = {
      order_id: generateOrderId(),
      request_uuid: crypto.randomUUID(),
      doc_type: docType,
      intake_status: "pending",

      customer_first_name: v.customer_first_name,
      customer_last_name: v.customer_last_name,
      customer_email: v.customer_email,
      customer_phone: v.customer_phone,
      customer_business_name: v.customer_business_name,

      entity_type: v.entity_type,
      entity_name: v.entity_name,
      governing_state: v.governing_state,
      formation_state: v.governing_state,

      parties,
      urgency: v.urgency,
      preferred_deadline: v.preferred_deadline || null,
      delivery_notes: v.delivery_notes,

      payment_status: "pending",
      variant_data
    };

    payload.raw_payload = payload;

    const { error } = await db.from("document_intake").insert([payload]);
    if (error) {
      alert("Error submitting intake: " + error.message);
      console.error(error);
      return;
    }

    window.location.href = `/review-and-pay.html?order_id=${payload.order_id}`;
  });
</script>

</body>
</html>
