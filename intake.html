<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E-LegalBoom | Client Intake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 24px;
      max-width: 960px;
      margin: auto;
      background: #f9f9f9;
    }
    h1, h2, h3 {
      margin-top: 28px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      font-size: 14px;
    }
    textarea {
      min-height: 90px;
    }
    .row {
      display: flex;
      gap: 16px;
    }
    .row > div {
      flex: 1;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-top: 20px;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0,0,0,0.08);
    }
    button {
      margin-top: 30px;
      padding: 14px 28px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h1>E-LegalBoom — Document Intake</h1>

<form id="intakeForm">

  <!-- =====================================================
       CONTEXT (RECEIVED FROM TIERS — NEVER VALIDATED HERE)
       ===================================================== -->
  <input type="hidden" name="doc_type" id="doc_type">
  <input type="hidden" name="tier" id="tier">

  <!-- =====================================================
       CLIENT INFORMATION
       ===================================================== -->
  <div class="section">
    <h2>Client Information</h2>

    <div class="row">
      <div>
        <label>First Name
          <input name="customer_first_name" required>
        </label>
      </div>
      <div>
        <label>Last Name
          <input name="customer_last_name" required>
        </label>
      </div>
    </div>

    <label>Email
      <input name="customer_email" type="email" required>
    </label>

    <label>Phone
      <input name="customer_phone">
    </label>

    <label>Business / Entity Name
      <input name="customer_business_name">
    </label>
  </div>

  <!-- =====================================================
       ENTITY & JURISDICTION
       ===================================================== -->
  <div class="section">
    <h2>Entity & Jurisdiction</h2>

    <label>Entity Type
      <select name="entity_type">
        <option value="">Select…</option>
        <option>Individual</option>
        <option>LLC</option>
        <option>Corporation</option>
        <option>Partnership</option>
        <option>Trust</option>
      </select>
    </label>

    <label>Entity Name
      <input name="entity_name">
    </label>

    <label>Governing State
      <select name="governing_state" required>
        <option value="">Select…</option>
        <option>AL</option><option>AK</option><option>AZ</option><option>AR</option>
        <option>CA</option><option>CO</option><option>CT</option><option>DE</option>
        <option>FL</option><option>GA</option><option>HI</option><option>ID</option>
        <option>IL</option><option>IN</option><option>IA</option><option>KS</option>
        <option>KY</option><option>LA</option><option>ME</option><option>MD</option>
        <option>MA</option><option>MI</option><option>MN</option><option>MS</option>
        <option>MO</option><option>MT</option><option>NE</option><option>NV</option>
        <option>NH</option><option>NJ</option><option>NM</option><option>NY</option>
        <option>NC</option><option>ND</option><option>OH</option><option>OK</option>
        <option>OR</option><option>PA</option><option>RI</option><option>SC</option>
        <option>SD</option><option>TN</option><option>TX</option><option>UT</option>
        <option>VT</option><option>VA</option><option>WA</option><option>WV</option>
        <option>WI</option><option>WY</option>
      </select>
    </label>
  </div>

  <!-- =====================================================
       PARTIES
       ===================================================== -->
  <div class="section">
    <h2>Parties</h2>

    <div class="row">
      <div>
        <label>Party 1 Name
          <input name="party1_name">
        </label>
      </div>
      <div>
        <label>Role
          <input name="party1_role">
        </label>
      </div>
      <div>
        <label>Email
          <input name="party1_email">
        </label>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Party 2 Name
          <input name="party2_name">
        </label>
      </div>
      <div>
        <label>Role
          <input name="party2_role">
        </label>
      </div>
      <div>
        <label>Email
          <input name="party2_email">
        </label>
      </div>
    </div>
  </div>

  <!-- =====================================================
       TIMING & NOTES
       ===================================================== -->
  <div class="section">
    <h2>Timeline & Notes</h2>

    <label>Urgency
      <input name="urgency">
    </label>

    <label>Preferred Deadline
      <input type="date" name="preferred_deadline" id="preferred_deadline">
    </label>

    <label>Additional Notes
      <textarea name="notes"></textarea>
    </label>
  </div>

  <!-- =====================================================
       SUBMIT
       ===================================================== -->
  <button type="submit">Continue to Review & Pay</button>

</form>

<script>
/* =====================================================
   CONFIG
   ===================================================== */
const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =====================================================
   RECEIVE CONTEXT — NO BLOCKING
   ===================================================== */
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);

  const docType = params.get("doc_type") || "";
  const tier = params.get("tier") || "";

  document.getElementById("doc_type").value = docType;
  document.getElementById("tier").value = tier;

  const today = new Date().toISOString().split("T")[0];
  const dateField = document.getElementById("preferred_deadline");
  if (dateField && !dateField.value) dateField.value = today;

  console.log("INTAKE CONTEXT RECEIVED:", { docType, tier });
});

/* =====================================================
   HELPERS
   ===================================================== */
function generateOrderId() {
  const d = new Date().toISOString().slice(0,10).replace(/-/g,'');
  const r = Math.floor(1000 + Math.random() * 9000);
  return `ELB-${d}-${r}`;
}

/* =====================================================
   SUBMIT
   ===================================================== */
document.getElementById("intakeForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const fd = new FormData(e.target);
  const v = Object.fromEntries(fd.entries());

  const parties = [];
  if (v.party1_name) parties.push({ name: v.party1_name, role: v.party1_role, email: v.party1_email });
  if (v.party2_name) parties.push({ name: v.party2_name, role: v.party2_role, email: v.party2_email });

  const payload = {
    order_id: generateOrderId(),
    doc_type: v.doc_type || null,
    tier: v.tier || null,
    intake_status: "pending",

    customer_first_name: v.customer_first_name,
    customer_last_name: v.customer_last_name,
    customer_email: v.customer_email,
    customer_phone: v.customer_phone,
    customer_business_name: v.customer_business_name,

    entity_type: v.entity_type,
    entity_name: v.entity_name,
    governing_state: v.governing_state,

    parties,
    urgency: v.urgency,
    preferred_deadline: v.preferred_deadline || null,
    notes: v.notes,

    stripe_metadata: {
      product_key: v.doc_type || null,
      tier: v.tier || null
    }
  };

  payload.raw_payload = payload;

  const { error } = await db
    .from("document_intake")
    .insert([payload]);

  if (error) {
    console.error(error);
    alert("Intake submission failed. Check console.");
    return;
  }

  window.location.href =
    `/review-and-pay.html?order_id=${payload.order_id}&doc_type=${v.doc_type}&tier=${v.tier}`;
});
</script>

</body>
</html>
